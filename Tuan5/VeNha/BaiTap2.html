<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flappy Bird</title>
<style>
  :root{
    --game-w: 420px;
    --game-h: 600px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji";
    background:#7ecaff;
    display:grid;
    place-items:center;
    min-height:100vh;
  }

  /* Khung game */
  #game{
    position:relative;
    width:var(--game-w);
    height:var(--game-h);
    overflow:hidden;
    background: linear-gradient(#87CEFA 60%, #c2f2ff 100%);
    border-radius:16px;
    box-shadow:0 12px 40px rgba(0,0,0,.25);
  }

  /* M·∫∑t ƒë·∫•t ƒë∆°n gi·∫£n */
  .ground{
    position:absolute;
    left:0; right:0; bottom:0;
    height:80px;
    background: repeating-linear-gradient(
      -45deg,
      #8BC34A 0 20px,
      #7CB342 20px 40px
    );
  }

  /* ƒêi·ªÉm & level */
  .hud{
    position:absolute;
    left:10px; top:8px;
    color:#004;
    text-shadow:0 2px 0 #fff6;
    font-weight:700;
    font-size:16px;
    line-height:1.2;
    user-select:none;
  }
  .hud .level{font-size:18px}
  .score{
    position:absolute;
    right:10px; top:8px;
    font-weight:800;
    color:#004;
    text-shadow:0 2px 0 #fff6;
    user-select:none;
    font-size:20px;
  }

  /* Bird */
  .bird{
    --size: 138px;
    position:absolute;
    left:80px;
    top:200px;
    width:var(--size);
    height:var(--size);
    background: var(--bird-url) center/cover no-repeat;
    filter: drop-shadow(0 4px 2px rgba(0,0,0,.2));
    transform-origin:center;
    border-radius:50%;
  }

  /* Pipe */
  .pipe{
    --pipe-w: 70px;
    position:absolute;
    top:0;
    left:100%;
    width:var(--pipe-w);
    height:100%;
  }
  .pipe .top,
  .pipe .bottom{
    position:absolute;
    left:0;
    width:100%;
    background: var(--pipe-url) center/cover no-repeat;
  }
  .pipe .top{
    top:0;
    transform: scaleY(-1);
    border-bottom-left-radius:6px;
    border-bottom-right-radius:6px;
  }
  .pipe .bottom{
    bottom:80px; /* ch·ª´a n·ªÅn */
    border-top-left-radius:6px;
    border-top-right-radius:6px;
  }

  /* Overlay th√¥ng b√°o */
  .overlay{
    position:absolute; inset:0;
    background: rgba(0,0,0,.45);
    display:none;
    align-items:center;
    justify-content:center;
    text-align:center;
    color:#fff;
    padding:24px;
  }
  .overlay.show{ display:flex; }
  .dialog{
    background:#ffffffee;
    color:#123;
    border-radius:16px;
    padding:20px 18px;
    width:min(320px, 90%);
    box-shadow:0 12px 40px rgba(0,0,0,.25);
  }
  .dialog h2{margin:.2em 0 .4em}
  .dialog p{margin:.3em 0}
  .btn{
    display:inline-block;
    background:#0d9488;
    color:#fff; border:0; border-radius:8px;
    padding:10px 14px; cursor:pointer;
    margin-top:8px; font-weight:700;
  }
  .btn:hover{ filter:brightness(1.05) }
  .hint{
    position:absolute; left:50%; bottom:12px; transform:translateX(-50%);
    background:#ffffffd0; color:#123;
    padding:6px 10px; border-radius:8px; font-size:13px;
    user-select:none;
  }
</style>
</head>
<body>

<div id="game">
  <div class="hud">
    <div class="level">Level: <span id="level">1</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>
  <div class="score">Score: <span id="score">0</span></div>

  <div id="bird" class="bird" aria-label="bird" role="img"></div>

  <div class="ground"></div>

  <div id="overlay" class="overlay" aria-live="polite">
    <div class="dialog">
      <h2 id="title">Game Over</h2>
      <p id="message">B·∫°n ƒë·∫°t 0 ƒëi·ªÉm.</p>
      <button id="restart" class="btn">Ch∆°i l·∫°i (R)</button>
    </div>
  </div>

  <div class="hint">Nh·∫•n <b>Arrow&nbsp;Down</b> ƒë·ªÉ bay l√™n ‚Ä¢ Nh·∫•n <b>R</b> ƒë·ªÉ ch∆°i l·∫°i</div>
</div>

<script>
const CONFIG = {
  BIRD_URL:
    "https://www.pngmart.com/files/12/Flappy-Bird-PNG-Image.png",
  PIPE_URL:
    "https://toppng.com/uploads/preview/mobile-flappy-bird-version-12-sprites-the-spritersthe-tubo-de-mario-bros-11562922972x2nzafuu7e.png",

  GAP: 150,          // kho·∫£ng tr·ªëng gi·ªØa 2 ·ªëng
  PIPE_DISTANCE: 220,// kho·∫£ng c√°ch gi·ªØa c√°c c·∫∑p ·ªëng
  PIPE_SPEED: 2.4,   // t·ªëc ƒë·ªô tr√¥i sang tr√°i (px / tick)
  GRAVITY: 0.45,     // tr·ªçng l·ª±c (px / tick)
  JUMP: -8.8,        // l·ª±c nh·∫£y khi nh·∫•n ArrowDown (t·ªëc ƒë·ªô Y)
  GROUND_H: 80,      // chi·ªÅu cao m·∫∑t ƒë·∫•t
  WIN_SCORE: 50,     // m·ªëc th·∫Øng
  // M·ªëc Level + th·ªùi gian tick (ms)
  LEVELS: [
    { minScore: 0,   interval: 40, name: "1" },
    { minScore: 5,   interval: 30, name: "2" },
    { minScore: 20,  interval: 25, name: "3" },
    { minScore: 40,  interval: 20, name: "4" }
  ]
};

// g√°n CSS bi·∫øn ·∫£nh
document.documentElement.style.setProperty('--bird-url', `url("${CONFIG.BIRD_URL}")`);
document.documentElement.style.setProperty('--pipe-url', `url("${CONFIG.PIPE_URL}")`);

const gameEl   = document.getElementById('game');
const birdEl   = document.getElementById('bird');
const overlay  = document.getElementById('overlay');
const titleEl  = document.getElementById('title');
const msgEl    = document.getElementById('message');
const btnRestart = document.getElementById('restart');
const scoreEl  = document.getElementById('score');
const bestEl   = document.getElementById('best');
const levelEl  = document.getElementById('level');

const GAME_W = parseInt(getComputedStyle(gameEl).width);
const GAME_H = parseInt(getComputedStyle(gameEl).height);

let pipes = [];
let score = 0;
let best = +localStorage.getItem('flap_best') || 0;
bestEl.textContent = best;

let tickTimer = null;    // setInterval ID cho v√≤ng l·∫∑p
let spawnTimer = 0;      // ƒë·∫øm ƒë·ªÉ spawn ·ªëng m·ªõi
let tickMs = CONFIG.LEVELS[0].interval; // m·∫∑c ƒë·ªãnh theo Level 1
let running = false;

let bird = {
  x: 80,
  y: 200,
  vy: 0,
  size: parseInt(getComputedStyle(birdEl).width)
};

// ƒë·∫∑t v·ªã tr√≠ bird
function renderBird(){
  birdEl.style.left = bird.x + 'px';
  birdEl.style.top  = bird.y + 'px';
}

// t·∫°o 1 c·∫∑p ·ªëng
function createPipe(){
  const maxTop = GAME_H - CONFIG.GROUND_H - 40;
  const gap = CONFIG.GAP;

  // chi·ªÅu cao ph·∫ßn top ng·∫´u nhi√™n
  const topH = Math.floor(60 + Math.random() * (maxTop - gap - 60));
  const bottomH = maxTop - topH - gap;

  const pipe = document.createElement('div');
  pipe.className = 'pipe';
  pipe.style.left = GAME_W + 'px';

  const top = document.createElement('div');
  top.className = 'top';
  top.style.height = topH + 'px';

  const bottom = document.createElement('div');
  bottom.className = 'bottom';
  bottom.style.height = bottomH + 'px';

  pipe.appendChild(top);
  pipe.appendChild(bottom);
  gameEl.appendChild(pipe);

  pipes.push({
    el: pipe,
    x: GAME_W,
    topH,
    bottomH,
    passed: false
  });
}

// c·∫≠p nh·∫≠t t·ªëc ƒë·ªô tick theo level d·ª±a tr√™n ƒëi·ªÉm
function updateLevelByScore(){
  let lvl = CONFIG.LEVELS[0];
  for(const L of CONFIG.LEVELS){
    if(score >= L.minScore) lvl = L;
  }
  levelEl.textContent = lvl.name;

  if (tickMs !== lvl.interval){
    tickMs = lvl.interval;
    if (running){
      clearInterval(tickTimer);
      tickTimer = setInterval(tick, tickMs);
    }
  }
}

// ki·ªÉm tra va ch·∫°m
function collidePipe(p, px, py, size){
  const pipeW = parseInt(getComputedStyle(p.el).width);
  // v√πng ·ªëng (x range)
  if (px + size > p.x && px < p.x + pipeW){
    // ch·∫°m ph·∫ßn top?
    if (py < p.topH) return true;
    // ch·∫°m ph·∫ßn bottom?
    const gapTop = p.topH + CONFIG.GAP;
    const bottomTopY = gapTop;
    const groundTop = GAME_H - CONFIG.GROUND_H;
    if (py + size > bottomTopY && py + size < groundTop){
      return true;
    }
  }
  return false;
}

// d·ª´ng game
function stopGame(textTitle, textMsg){
  running = false;
  clearInterval(tickTimer);
  tickTimer = null;

  titleEl.textContent = textTitle;
  msgEl.textContent = textMsg;
  overlay.classList.add('show');

  // l∆∞u best
  if (score > best){
    best = score;
    localStorage.setItem('flap_best', best);
    bestEl.textContent = best;
  }
}

// v√≤ng l·∫∑p ch√≠nh
function tick(){
  // 1) Bird: r∆°i + render
  bird.vy += CONFIG.GRAVITY;
  bird.y  += bird.vy;

  // ch·∫°m tr·∫ßn
  if (bird.y < 0) bird.y = 0;

  // ch·∫°m ƒë·∫•t
  const groundY = GAME_H - CONFIG.GROUND_H - bird.size;
  if (bird.y >= groundY){
    bird.y = groundY;
    renderBird();
    stopGame('Game Over', `B·∫°n ch·∫°m ƒë·∫•t! ƒêi·ªÉm: ${score}`);
    return;
  }

  renderBird();

  // 2) Pipes: di chuy·ªÉn + va ch·∫°m + t√≠nh ƒëi·ªÉm
  spawnTimer += tickMs;
  // t·∫°o pipe c√°ch nhau PIPE_DISTANCE (quy ra th·ªùi gian = qu√£ng ƒë∆∞·ªùng / t·ªëc ƒë·ªô)
  const timeToSpawn = CONFIG.PIPE_DISTANCE / CONFIG.PIPE_SPEED * tickMs;
  if (spawnTimer >= timeToSpawn){
    spawnTimer = 0;
    createPipe();
  }

  for (let i = pipes.length - 1; i >= 0; i--){
    const p = pipes[i];
    p.x -= CONFIG.PIPE_SPEED;
    p.el.style.left = p.x + 'px';

    // check va ch·∫°m
    if (collidePipe(p, bird.x, bird.y, bird.size)){
      stopGame('Game Over', `B·∫°n va v√†o ·ªëng! ƒêi·ªÉm: ${score}`);
      return;
    }

    // ƒë√£ v∆∞·ª£t qua ·ªëng ch∆∞a (t√≠nh ƒëi·ªÉm 1 l·∫ßn)
    const pipeW = parseInt(getComputedStyle(p.el).width);
    if (!p.passed && p.x + pipeW < bird.x){
      p.passed = true;
      score++;
      scoreEl.textContent = score;
      updateLevelByScore();

      // th·∫Øng
      if (score >= CONFIG.WIN_SCORE){
        stopGame('Chi·∫øn th·∫Øng üéâ', `Xu·∫•t s·∫Øc! B·∫°n ƒë·∫°t ${score} ƒëi·ªÉm (Level ${levelEl.textContent}).`);
        return;
      }
    }

    // lo·∫°i b·ªè ·ªëng ƒë√£ ƒëi kh·ªèi m√†n
    if (p.x + pipeW < -10){
      p.el.remove();
      pipes.splice(i, 1);
    }
  }
}

// b·∫Øt ƒë·∫ßu game (ho·∫∑c kh·ªüi t·∫°o l·∫°i)
function startGame(){
  // reset
  overlay.classList.remove('show');
  pipes.forEach(p => p.el.remove());
  pipes = [];
  score = 0;
  scoreEl.textContent = score;
  bird.x = 80;
  bird.y = 200;
  bird.vy = 0;
  renderBird();
  updateLevelByScore();
  spawnTimer = 0;

  // ch·∫°y
  running = true;
  clearInterval(tickTimer);
  tickTimer = setInterval(tick, tickMs);
}

// x·ª≠ l√Ω ƒëi·ªÅu khi·ªÉn
function handleKey(e){
  // ArrowDown = v·∫´y c√°nh (bay l√™n)
  if (e.code === 'ArrowDown'){
    // n·∫øu ch∆∞a ch·∫°y th√¨ kh·ªüi ƒë·ªông
    if (!running){
      startGame();
    }
    bird.vy = CONFIG.JUMP; // bay l√™n
    // xoay nh·∫π cho c·∫£m gi√°c
    birdEl.style.transform = 'rotate(-12deg)';
    setTimeout(() => birdEl.style.transform = 'rotate(0deg)', 120);
  }
  // R = restart nhanh
  if (e.code === 'KeyR'){
    startGame();
  }
}

document.addEventListener('keydown', handleKey);
btnRestart.addEventListener('click', startGame);

// kh·ªüi t·∫°o hi·ªÉn th·ªã ban ƒë·∫ßu
renderBird();
updateLevelByScore();
</script>
</body>
</html>

